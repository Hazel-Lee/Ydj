<!--
@Design Juice
@Author Jobizzness.com
This is our main app element. Without this our app will not function.
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="components/app-env/app-env.html">
<link rel="import" href="components/app-auth/app-auth.html">

<link rel="lazy-import" href="app-overview.html">
<dom-module id="my-app">

  <template>
    <app-auth signed-in="{{loggedIn}}" id="auth" user="{{user}}" on-set="_allSet"></app-auth>
    <app-overview user="[[user]]" logged-in="[[loggedIn]]" id="app"></app-overview>
  </template>

  <script>
    class MyApp extends Polymer.Element {

      static get is() { return 'my-app'; }

     /**
      * Runs when this @component is loaded.
      * Listeners are set here to listen for auth changes.
      */
      ready(){
        super.ready();
        //When Auth changes we will handle it.
        this.$.auth.onAuthStateChanged((e) => this._handleAuthChanged(e.detail.value));

        //Login or Logout Listeners
        window.addEventListener('login', e => this._login(e));
        window.addEventListener('signout', e => this._signOut(e));

      }

      /**
       * When auth changes we will tell everyone.
       * @param user
       * @private
       */
      _handleAuthChanged(user){
        this.$.app.loggedIn = (this.user) ? true : false;
      }

      /**
       * Will attempt to log the user in when the credentials are provided.
       * @param event
       * @private
       */
      _login(e){
        let creds = e.detail;

        //I can validate the user input here.
        if(e.detail){
          this.$.auth.signInWithUserNameAndPassword(creds.username, creds.password);
          return;
        }
      }


      _signOut(e){
        this.$.auth.signOut();
      }

      /**
       * App must be ready so lets import overview page.
       * @param event
       * @private
       */
      _allSet(e){
        Polymer.importHref(this.resolveUrl('app-overview.html'), null, null, true);
      }
    }

    window.customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>
