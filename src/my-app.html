<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="components/app-env/app-env.html">
<link rel="import" href="components/app-auth/app-auth.html">

<link rel="lazy-import" href="app-overview.html">
<dom-module id="my-app">
  <template>

    <app-auth signed-in="{{loggedIn}}" id="auth" user="{{user}}" on-set="_allSet"></app-auth>
    <app-overview user="[[user]]" logged-in="{{loggedIn}}" id="app"></app-overview>


  </template>

  <script>
    class MyApp extends Polymer.Element {

      static get is() { return 'my-app'; }

      ready(){
        super.ready();
        this.$.auth.onAuthStateChanged((e) => {
          this._handleAuthChanged(e.detail.value);
          
        });

        window.addEventListener('login', e => this._login(e));

        // Start downloading and initializing the overview page once the login page has rendered
        Polymer.RenderStatus.afterNextRender(this.$.auth, () => {
          
        });
      }

      _handleAuthChanged(user){
        if(user){
          this.$.app.userIsLoggedIn();
        }
      }

      _login(e){
        let creds = e.detail;
        this.$.auth.signInWithUserNameAndPassword(creds.username, creds.password);
      }
      _allSet(e){
        Polymer.importHref(this.resolveUrl('app-overview.html'), null, null, true);
      }
    }

    window.customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>
